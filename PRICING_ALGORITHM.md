# Алгоритм рекомендации цен на металлопродукцию

## Описание

Реализован алгоритм ценообразования для трубного завода, который анализирует рыночные данные и рекомендует корректировки цен на основе:

1. **Cost-plus модели** - учет себестоимости на основе рыночных индексов (лом, рулон, курс валют, ставка ЦБ)
2. **Конкурентного анализа** - сравнение с ценами конкурентов из данных 23met
3. **Смешанного подхода** - взвешенное сочетание себестоимости и рыночных цен

## Архитектура

### Backend (Python/FastAPI)

- `src/data/market_data.py` - управление рыночными данными
- `src/algorithms/pricing_algorithm.py` - основной алгоритм ценообразования  
- `src/pricing/` - API для работы с рекомендациями
  - `models.py` - модели данных
  - `service.py` - бизнес-логика
  - `controller.py` - API endpoints

### Frontend (React/TypeScript)

- `frontend/src/components/PriceRecommendations.tsx` - компонент рекомендаций
- `frontend/src/api.ts` - API клиент для работы с рекомендациями

## API Endpoints

- `POST /api/pricing/recommend` - получить рекомендацию для одного продукта
- `POST /api/pricing/recommend/bulk` - получить рекомендации для нескольких продуктов
- `GET /api/pricing/market-data` - получить рыночные данные
- `POST /api/pricing/market-data/update` - обновить рыночные данные
- `GET /api/pricing/health` - проверка работоспособности

## Алгоритм работы

### 1. Расчет индекса себестоимости

Нормализация рыночных данных относительно среднего за последние 6 месяцев:
- Рулон: 60-67% веса
- Лом: 30-35% веса  
- Курс USD: 5-7% веса (если доступен)
- Ставка ЦБ: 3% веса (если доступна)

### 2. Анализ конкурентов

Поиск конкурентов по критериям:
- ГОСТ
- Диаметр/типоразмер
- Марка стали
- Регион

При недостатке данных ослабляются фильтры.

### 3. Смешивание таргетов

Вес рыночного якоря зависит от количества конкурентов:
- λ = 0.3 + 0.5 * min(1, n_competitors/5)
- Диапазон: 0.3-0.8

### 4. Принятие решения

- Нейтральная зона: ±1.5%
- Максимальный шаг: ±3%
- Действия: "повысить", "понизить", "оставить", "установить"

### 5. Уверенность

Базовая уверенность 50% + бонусы:
- +20% если конкурентов ≥3
- +10% если история ≥12 точек
- +5% за курс валют
- +5% за ставку ЦБ

Диапазон: 20-90%

## Формат данных

### Входные данные продукта

```json
{
  "вид_продукции": "string",
  "склад": "string", 
  "наименование": "string",
  "марка_стали": "string",
  "диаметр": "string",
  "ГОСТ": "string",
  "цена": 0,
  "производитель": "string",
  "регион": "string"
}
```

### Ответ рекомендации

```json
{
  "input": {...},
  "decision": {
    "action": "повысить|понизить|оставить|установить",
    "delta_percent": 2.5,
    "new_price": 76875
  },
  "targets": {
    "baseline_target_cost_plus": 73758,
    "market_anchor_median": 75500,
    "blend_lambda_market_weight": 0.60,
    "final_target_price": 74803
  },
  "coverage": {
    "competitors_used": 3,
    "history_points": 12
  },
  "confidence": 0.90,
  "explain": "Основной вес на рыночные цены конкурентов..."
}
```

## Рыночные данные

По умолчанию загружены данные за 12 месяцев (2024-09 - 2025-08):

| Месяц | Лом (руб/т) | Рулон (руб/т) | USD/RUB | Ставка ЦБ (%) |
|-------|-------------|---------------|---------|---------------|
| 2024-09 | 31,200 | 61,800 | 95.5 | 16.0 |
| 2024-10 | 30,500 | 60,200 | 96.2 | 16.0 |
| ... | ... | ... | ... | ... |
| 2025-08 | 32,900 | 63,200 | 103.5 | 16.0 |

## Использование

1. Запустить backend сервер
2. Открыть фронтенд дашборд
3. Перейти на вкладку "Рекомендации по ценам"
4. Настроить фильтры при необходимости
5. Нажать "Обновить" для получения рекомендаций
6. Просмотреть детали рекомендации
7. Применить рекомендуемые изменения

## Особенности для хакатона

- Простая и понятная логика без сложного ML
- Работает с ограниченными данными
- Понятные объяснения для менеджеров
- Быстрая интеграция в существующий дашборд
- Надежные fallback'и при ошибках
